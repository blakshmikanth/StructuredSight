<#@ assembly name="System.Core" #>
<#@ assembly name="System.Data" #>
<#@ import namespace="System.Linq" #>
<#@ import namespace="System.Text" #>
<#@ import namespace="System.Collections.Generic" #>
<#@ import namespace="System.Data.SqlClient" #>
<#@ import namespace="System" #>

<#@ include file="Classes.tt"#>
<#@ output extension=".cs" #>

using System;
using System.Collections.Generic;
using System.Linq;

<#
	const string connectString = @"Data Source=localhost\sqlExpress;Initial Catalog=Scheduler;Integrated Security=SSPI;";

//		command.CommandText = "SELECT Name, Object_Id FROM sys.procedures WHERE Name NOT LIKE 'sp_%'";

		var tableValuedColumns = DbConnection.Invoke<IEnumerable<Table>>(connectString, HelperFunctions.GetTables); 
		var procedures = DbConnection.Invoke<IEnumerable<Procedure>>(connectString, HelperFunctions.GetProcedure);
		var createProcedureHeader = new Func<BaseObject,string> (baseObject=>String.Format("public partial class {0} : IDbQuery {{", baseObject.Name));
		var createTableValuedColumnHeader = new Func<BaseObject,string> (baseObject=>String.Format("public partial class {0} {{", baseObject.Name));
		var createResultColumnHeader = new Func<BaseObject,string> (baseObject=>String.Format("public partial class {0}_Result {{", baseObject.Name));
		var createProperty = new Func<Column, string>(c => {
			var columnDataType = Parameters.GetParameterType(c);
			 
			return string.Format("public {0} {1} {{get;set;}}", columnDataType, c.Name);});
#> 

<#const string _codeNamspace = "CompileTimeStoredProcedures";#>
<#const string _tvpNamespace = _codeNamspace + "TableValuedParameter";#>

/*Start Table Valued Columns*/ 
<# 
	foreach(var t in tableValuedColumns)
	{
		#>

		namespace <#=_tvpNamespace#>.<#=t.Schema#>
		{ 
			<#=createTableValuedColumnHeader(t)#>
				<#=String.Join(System.Environment.NewLine, 
					t.Columns.Select(x=>"public " + x.GetCSType(_tvpNamespace) + " " + x.Name + "{get;set;}"))#>
			} 

		}

		<#
		}
#>
/*End Table Valued Columns*/
  



<#foreach(var procedure in procedures)
  {
      try 
      {	        
		
  #> 
  namespace <#=_codeNamspace#>.Query.<#=procedure.Schema#>
  { 
   
	  <#=createProcedureHeader(procedure)#>
	 
	  	public <#=procedure.Name#> ( 
			<#=String.Join("," + System.Environment.NewLine, procedure.Columns.Select(x=> x.GetCSType(_tvpNamespace) + " " + x.CamelCase))#>
		)
		{
			<#=String.Join(System.Environment.NewLine, procedure.Columns.Select(x=> "_" +  x.CamelCase + " = " + x.CamelCase + ";"))#>
		}  
		
			public String Query {get{return "<#=procedure.Name#>";}}
			<#= String.Join(System.Environment.NewLine, procedure.Columns.Select (parm => "private readonly "  + parm.GetCSType(_tvpNamespace) + " _" + parm.CamelCase + ";")) #>
	
			<#=String.Join (System.Environment.NewLine, procedure.Columns.Select(parm => "public " + 
								parm.GetCSType(_tvpNamespace) + " " + parm.CSName + "{get {return _" + parm.CamelCase + ";}}"))#>


			public IEnumerable<StoredProcedureParameterTypeAndValue> SqlParameters {
				get {
					
					<#if(procedure.Columns.Count() == 0){#>return new StoredProcedureParameterTypeAndValue[0];<#}#>

					<#foreach(var parameter in procedure.Columns)
					{
						if(parameter.AllowsNull)
                        {
							if(parameter.GetCSType(_tvpNamespace).Contains("?"))//using HasValue for nullables instead of checking for null
							{
								#>if(!_<#=parameter.CamelCase#>.HasValue)<#
                            }
							else{
								#>if(_<#=parameter.CamelCase#> != null)<#
                            }
							#>
							{
								yield return new StoredProcedureParameterTypeAndValue {Value = _<#=parameter.CamelCase#>, ParameterName = "<#=parameter.Name#>"};

							}<#
                        }
						else 
						{
							#>
								yield return new StoredProcedureParameterTypeAndValue {Value = _<#=parameter.CamelCase#>, ParameterName = "<#=parameter.Name#>"};
							<#		
                        }
                    }	#>							
					
				}

			}
	
		}
	}

	namespace <#=_codeNamspace#>.Result.<#=procedure.Schema#>
	{ 
		<#=createResultColumnHeader(procedure)#>

		<#
			foreach(var returnField in procedure.ReturnFields)
			{
				#><#=createProperty(returnField)#>
				
				<#
			} 
  

		#>
		}
	}

<#
	        }
      catch ( Exception ex )
      {
		
          #>//{"Procedure": "<#=procedure.Name#>" Message: "<#=ex.Message#>"}<#
      }

	  
	  
	  }



#>
